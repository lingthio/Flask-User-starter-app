{% extends "layout.html" %}

{% block content %}
{% include 'js_util.html' %}
<script type="text/javascript" class="init">

    // Function to create drop down menu for user assignment
    function createUserAssignSelect(rowObject) {
        // Fetch users of current project
        let table = $('#admin_overview_table').DataTable();
        let project_users = table.ajax.json()["project_users"];

        let sel = "<select class='userAssign custom-select'>";
        if (rowObject["manual_segmentation"]["assignee_id"] != null){
            sel += "<option>Not Assigned</option>";
        } else {
            sel += "<option selected>Not Assigned</option>";
        }
        if (rowObject["manual_segmentation"]["status"] === "open_for_segmentation"){
            sel += "<option selected>Open for Segmentation</option>";
        } else {
            sel += "<option>Open for Segmentation</option>";
        }

        for (let user of project_users) {
            let user_representation = user["first_name"] + " " + user["last_name"] + " (" + user["email"] + ")";
            if (user["id"] === rowObject["manual_segmentation"]["assignee_id"]) {
                sel += "<option selected value = '" + user["id"] + "' >" + user_representation + "</option>";
            } else {
                sel += "<option value = '" + user["id"] + "' >" + user_representation + "</option>";
            }
        }
        sel += "</select>";
        return sel;
    }

    // Function to create drop down menu for split assignment
    function createSplitAssignSelect(rowObject) {
        // Fetch users of current project
        let table = $('#admin_overview_table').DataTable();
        let options = ["train", "test", "validation"];

        // Build select
        let sel = "<select class='splitAssign custom-select'><option value=null>Assign</option>";

        for (let option of options) {
            if (option === rowObject["split"]) {
                sel += "<option selected >" + option + "</option>";
            } else {
                sel += "<option >" + option + "</option>";
            }
        }
        sel += "</select>";
        return sel;
    }


    // Save meta data like project id, user id and role
    let project_id = {{data.current_project.id}};
    let user_id = {{data.user.id}};
    let role = '{{data.role}}';


    $(document).ready(function () {
        // Table definition
        $('#admin_overview_table').DataTable({
            serverSide: true,
            ajax: {
                url: "/data/projects_data",
                beforeSend: function (request) {
                    request.setRequestHeader("project_id", project_id);
                    request.setRequestHeader("user_id", user_id);
                    request.setRequestHeader("role", role);
                },
                data: function ( args ) {
                    return { "args": JSON.stringify( args ) };
                }

            },
            columns: [
                {
                    name: 'name',
                    data: 'name'
                },
                {
                    data: null,
                    render: function(data){return createUserAssignSelect(data);}
                },
                {
                    data: null,
                    render: function(data){return createSplitAssignSelect(data);}
                },
                {
                    name: 'status',
                    data: null,
                    render: function(data){return createStatusLabel(data);}
                },
                {
                    data: null,
                    render: function (data, type, row) {
                        return '<button class="btn btn-primary segmentationUploadButton">Upload</button> ' +
                            '<button style="margin-left: 30px" class="btn btn-primary dataDownloadButton">Download</button>';
                    }
                },

            ],
            columnDefs: [{"className": "dt-center", "targets": "_all"}],
            autoWidth: false
        });

        // Add new data
        $('#imageUploadModalButton').click(function () {
            let table = $('#admin_overview_table').DataTable();
            let projectObj = table.ajax.json()["project"];
            showImageUploadModal(projectObj);
        });



        // Make sure that every time an assignment is changed, an update is sent to the server
        $('#admin_overview_table').on('draw.dt', function () {
            // User assignment
            $('.userAssign').change(function () {
                // Get row object of row this select resides in
                let table = $('#admin_overview_table').DataTable();
                let rowObject = table.row($(this).closest('tr')).data();

                // Change assignee and status
                let value = $(this).val();
                let text = this.options[this.selectedIndex].text;

                if (text === "Not Assigned"){
                    rowObject["manual_segmentation"]["assignee_id"] = null;
                    rowObject["manual_segmentation"]["status"] = "not_open";
                } else if (text === "Open for Segmentation") {
                    rowObject["manual_segmentation"]["assignee_id"] = null;
                    rowObject["manual_segmentation"]["status"] = "open_for_segmentation";
                } else {
                    rowObject["manual_segmentation"]["assignee_id"] = parseInt(value);
                    rowObject["manual_segmentation"]["assigned_date"] = new Date(Date.now()).toUTCString();
                    rowObject["manual_segmentation"]["status"] = "assigned";
                }

                sendRowUpdateToServer(rowObject);
                table.draw(false);
            });

            // Split assignment
            $('.splitAssign').change(function () {
                // Get row object of row this select resides in
                let table = $('#admin_overview_table').DataTable();
                let rowObject = table.row($(this).closest('tr')).data();

                // Change assignee
                let value = $(this).val();
                let option = $(this).find('option:selected').text();

                if (value === "null"){
                    rowObject["split"] = null;
                } else {
                    rowObject["split"] = option;
                }

                // Send change to server
                sendRowUpdateToServer(rowObject);
            });

            // Upload new segmentations
            $('.segmentationUploadButton').click(function () {
                let table = $('#admin_overview_table').DataTable();
                let rowObject = table.row($(this).closest('tr')).data();
                showSegmentationUploadModal(rowObject);
            });

            // Download data
            $('.dataDownloadButton').click(function () {
                let table = $('#admin_overview_table').DataTable();
                let rowObject = table.row($(this).closest('tr')).data();

                showDownloadModal(rowObject);
            });
        });
    });
</script>
<table id="admin_overview_table" class="table table-striped table-hover dt-responsive nowrap">
    <thead>
    <tr>
        <th> Data ID</th>
        <th> Assign</th>
        <th> Split </th>
        <th> Status</th>
        <th> Data </th>
    </tr>
    </thead>
</table>

<button class="btn btn-primary" id="imageUploadModalButton">Upload Image</button>
{% endblock %}

{% block forms %}
{% include 'forms/image_upload_form.html' %}
{% include 'forms/segmentation_upload_form.html' %}
{% include 'forms/download_form.html' %}
{% endblock %}
