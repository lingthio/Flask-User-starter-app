{% extends "layout.html" %}

{% block content %}
<script type="text/javascript" class="init">

    var editor; // use a global for the submit and return data

    var table_def = [
        {
            type: 'readonly',
            title: 'ID',
            data: 'id',
            name: 'contrast_type_id',
            visible: false
        },
        {
            title: 'Name',
            data: 'name',
            create: true,
        },
        {
            title: 'Accession Number',
            data: 'accession_number'
        },
        {
            type: 'select',
            title: 'Status',
            name: 'status',
            data: 'manual_segmentation.status'
        },
        {
            type: 'select',
            title: 'Split',
            data: 'split',
            create: true,
        },
        {  
            title: 'Body Region',
            data: 'body_region',
            create: true,
        },
        {
            type: 'select',
            title: 'Modality',
            data: 'modality',
            create: true,
        },
        {
            type: 'select',
            title: 'Contrast',
            data: 'contrast_type',
            create: true,
        },
        {
            title: 'Series Name',
            data: 'series_name',
            visible: false
        },
        {
            title: 'Series Description',
            data: 'series_description',
            visible: false
        },
        {
            title: 'Series Number',
            data: 'series_number',
            visible: false
        },
        {
            title: 'Series Instance UID',
            data: 'series_instance_uid',
            visible: false
        },
        {
            title: 'Patient Name',
            data: 'patient_name',
            visible: false,
            create: true,
        },
        {
            type: 'date',
            title: 'DOB',
            data: 'patient_dob',
            visible: false,
            create: true,
        },
        {
            type: 'datetime',
            title: 'Insert Date',
            data: 'insert_date',
            visible: false
        },
        {
            type: 'datetime',
            title: 'Updated',
            data: 'last_updated',
            visible: false
        },
        {
            title: 'Institution',
            data: 'institution',
            visible: false,
            create: true,
        },
        {
            title: 'Custom 1',
            data: 'custom_1',
            visible: false
        },
        {
            title: 'Custom 2',
            data: 'custom_2',
            visible: false
        },
        {
            title: 'Custom 3',
            data: 'custom_3',
            visible: false
        },
        {
            type: 'upload',
            title: 'Image',
            data: 'upload_image',
            create: true,
        },
        {
            type: 'upload',
            title: 'Mask',
            data: 'upload_mask',
            create: true,
        },
    ];
 

    $(document).ready(function () {

        /*
        setup_data_table has to load data from the backend which is normally done asynchronous.
        This means, it returns an Array of Promises which include the API Calls to the backend.

        When those are fulfilled, we can instantiate the editor with the fields.

        */
        Promise.all(setup_data_table(table_def, '#datatable', '#toggle_columns')).then(() => {

            editor = new $.fn.dataTable.Editor({
                ajax: {
                    create: {
                        type: 'POST',
                        url:  '/api/data_pool/project/' + project_id + '/case'
                    },
                    edit: {
                        type: 'PUT',
                        url:  '/api/data_pool/project/' + project_id + '/case?id=_id_'
                    },
                    remove: {
                        type: 'DELETE',
                        url:  '/api/data_pool/project/' + project_id + '/case?id=_id_'
                    }
                },
                table: '#datatable',
                idSrc:  'id',
                //fields: table_def.filter(column => column.create)
                fields: table_def
            });

            editor.on('initCreate', function() {
                editor.show(); //Shows all fields

                table_def.forEach(field => {
                    // Only fields with the attribute create(: true) are shown
                    if(!field.create) {
                        editor.hide(field.name);
                    }
                });
            });

            editor.on('initEdit', function() {
                editor.show(); //Shows all fields

                // TODO decide, which fields should be hidden
            });

            console.log(editor);

            console.log(table_def);

        }).then(() => {
            datatable = $('#datatable').DataTable( {
                serverSide: true,
                dom: "Bfrtip",
                select: true,
                stateSave: true,
    
                ajax: {
                    url: '/api/data_pool/project/' + project_id + '/datatable',
                    type: 'POST',
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data: (args) => JSON.stringify(args),
                    // success: (data) => console.log(data),
                },
    
                columns: table_def,
                columnDefs: table_def, 
    
                scrollX: true,
                
                buttons: [
                        { extend: 'pageLength'},
                        { extend:'colvis' },
                        { extend: 'create', editor: editor },
                        { extend: 'edit',   editor: editor },
                        { extend: 'remove', editor: editor }
                ]
            });
        });
    });

</script>


<table id="datatable" class="table table-striped table-hover nowrap">
    <thead>
    <tr>
        <!-- table headers are added programmatically -->
    </tr>
    </thead>
</table>


{% endblock %}

{% block forms %}
{% include 'forms/image_upload_form.html' %}
{% include 'forms/segmentation_upload_form.html' %}
{% include 'forms/download_form.html' %}
{% endblock %}
